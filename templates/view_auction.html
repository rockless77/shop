{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ product.name }}</h2>

    <div class="row">
        <!-- Left Column: Product Images -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-body text-center bg-light p-3">
                    {% set primary_image = product.images|selectattr('is_primary', 'eq', true)|first %}
                    <div class="main-image mb-3">
                        {% if primary_image %}
                            <img src="{{ url_for('uploaded_file', filename=primary_image.filename) }}" 
                                 class="img-fluid" 
                                 alt="{{ product.name }}"
                                 style="max-height: 400px; width: auto; object-fit: contain;">
                        {% else %}
                            <img src="{{ url_for('static', filename='placeholder-product.png') }}" 
                                 class="img-fluid" 
                                 alt="{{ product.name }}"
                                 style="max-height: 400px; width: auto; object-fit: contain;">
                        {% endif %}
                    </div>
                    {% if product.images|length > 1 %}
                    <div class="thumbnail-gallery d-flex justify-content-center gap-2 mt-3">
                        {% for image in product.images %}
                            <img src="{{ url_for('uploaded_file', filename=image.filename) }}" 
                                 class="img-thumbnail" 
                                 style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                                 onclick="document.querySelector('.main-image img').src = this.src"
                                 alt="{{ product.name }} - Image {{ loop.index }}">
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Item #{{ product.id }}</span>
                        <div>
                            <span class="badge bg-{{ 'success' if product.status == 'active' else 'secondary' }}">
                                {{ product.status|title }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Description -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Item Description</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">{{ product.description|replace('\n', '<br>')|safe }}</p>
                    <div class="mt-3 p-3 bg-light rounded">
                        <p class="mb-1"><strong>Seller:</strong> {{ product.seller.username }}</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Bidding Panel -->
        <div class="col-md-5">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Place a Bid</h4>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="display-4 fw-bold">${{ "%.2f"|format(product.current_bid or product.start_price) }}</div>
                        <div class="text-muted mb-2">
                            {% if product.bids %}
                                {{ product.bids|length }} bid(s)
                            {% else %}
                                Starting price
                            {% endif %}
                        </div>
                        
                        <!-- Time Remaining -->
                        <div class="alert alert-{{ 'warning' if product.time_left.days < 1 else 'info' }} py-2 mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>Time Remaining:</span>
                                <strong>
                                    {{ product.time_left.days }}d {{ (product.time_left.seconds // 3600) }}h 
                                    {{ ((product.time_left.seconds % 3600) // 60) }}m
                                </strong>
                            </div>
                        </div>
                        
                        <!-- Highest Bidder Status -->
                        {% if product.highest_bidder and current_user.is_authenticated and product.highest_bidder.id == current_user.id %}
                            <div class="alert alert-success">
                                <i class="bi bi-trophy"></i> You are the highest bidder!
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Bidding Form -->
                    {% if product.status == 'active' %}
                        {% if current_user.is_authenticated and current_user.id != product.seller_id %}
                            <form id="bid-form" method="POST" action="{{ url_for('place_bid', product_id=product.id) }}">
                                <div class="input-group">
                                    <input type="number" id="bid_amount" name="bid_amount" class="form-control" 
                                           step="0.01" min="{{ (product.current_bid or product.start_price) + product.min_increment }}" 
                                           placeholder="Enter bid amount" required>
                                    <button type="submit" class="btn btn-primary">
                                        Place Bid
                                    </button>
                                </div>
                            </form>
                            {% if current_user.is_authenticated %}
                                {% set in_watchlist = product.id in (current_user.wishlist_items|map(attribute='product_id')|list) %}
                                <form method="POST" action="{{ url_for('add_to_wishlist', product_id=product.id) }}" class="mt-2">
                                    <button type="submit" class="btn btn-{{ 'danger' if in_watchlist else 'outline-secondary' }} btn-sm w-100">
                                        <i class="bi bi-heart{{ '-fill' if in_watchlist }}"></i>
                                        {{ 'Remove from' if in_watchlist else 'Add to' }} Watchlist
                                    </button>
                                </form>
                            {% else %}
                                <a href="{{ url_for('login', next=request.path) }}" class="btn btn-outline-secondary btn-sm w-100">
                                    <i class="bi bi-heart"></i> Sign in to Watchlist
                                </a>
                            {% endif %}
                        {% elif not current_user.is_authenticated %}
                            <div class="alert alert-info">
                                <a href="{{ url_for('login', next=request.path) }}">Sign in</a> to place a bid.
                            </div>
                        {% else %}
                            <div class="alert alert-warning">
                                You cannot bid on your own auction.
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-{{ 'success' if product.status == 'sold' else 'secondary' }}">
                            {% if product.status == 'sold' %}
                                This auction has ended. The item has been sold.
                                {% if product.highest_bidder and current_user.is_authenticated and product.highest_bidder.id == current_user.id %}
                                    Congratulations! You won this auction.
                                {% endif %}
                            {% else %}
                                This auction has ended without a sale.
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    <!-- Shipping Info -->
                    <hr>
                    <div class="shipping-info">
                        <h6 class="fw-bold">Shipping</h6>
                        <p class="mb-1">
                            <i class="bi bi-truck"></i> 
                            Free standard shipping
                        </p>
                        <p class="mb-0">
                            <i class="bi bi-clock"></i> 
                            Estimated delivery: 3-5 business days
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bid History Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Bid History</h5>
                </div>
                <div class="card-body p-0">
                    {% if product.bids %}
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Bidder</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bid in product.bids %}
                            <tr>
                                <td>
                                    {{ bid.bidder.username }}
                                    {% if bid.user_id == current_user.id %}
                                        <span class="badge bg-primary">You</span>
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(bid.amount) }}</td>
                                <td>{{ bid.created_at.strftime('%b %d, %Y %I:%M %p') }}</td>
                                <td>
                                    {% if loop.first %}
                                        <span class="badge bg-success">Highest</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="p-4 text-center text-muted">
                        <i class="bi bi-cash-stack" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No bids have been placed yet. Be the first to bid!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
(function() {
    'use strict';
    
    // Global variables
    var socket;
    var productId;
    var minIncrement;
    var currentBid;
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeAuction);
    
    function initializeAuction() {
        try {
            // Initialize variables
            socket = io();
            productId = parseInt("{{ product.id }}", 10);
            minIncrement = parseFloat("{{ product.min_increment }}");
            currentBid = parseFloat("{{ product.current_bid or product.start_price }}");
        
            // Join auction room
            socket.emit('join_auction', { product_id: productId });
            
            // Setup event listeners
            socket.on('bid_update', function(data) {
                if (data && data.product_id === productId) {
                    updateBidDisplay(data);
                }
            });
        
            window.addEventListener('beforeunload', function() {
                socket.emit('leave_auction', { product_id: productId });
            });
            
            // Setup timer and initial update
            setInterval(updateCountdown, 60000);
            updateCountdown();
            
            // Set global functions
            window.addToWatchlist = toggleWatchlist;
        } catch (error) {
            console.error('Error initializing auction:', error);
        }
    }
    
    function formatCurrency(amount) {
        return '$' + parseFloat(amount).toFixed(2);
    }
    
    function updateBidHistory(data) {
        var bidHistory = document.querySelector('.bid-history');
        if (!bidHistory) { return; }
        
        var newBid = document.createElement('div');
        newBid.className = 'alert alert-info mb-2';
        
        var bidderName = data.user_name || 'Anonymous';
        var bidAmount = formatCurrency(data.current_bid);
        var bidTime = data.bid_time || '';
        
        newBid.innerHTML = '<strong>' + bidderName + '</strong> bid ' + bidAmount + 
            ' <small class="text-muted ms-2">' + bidTime + '</small>';
        
        bidHistory.insertBefore(newBid, bidHistory.firstChild);
    }
    
    function updateBidForm(data) {
        var bidInput = document.querySelector('input[name="bid_amount"]');
        if (!bidInput) { return; }
        
        var nextMinBid = parseFloat(data.current_bid) + minIncrement;
        bidInput.min = nextMinBid;
        bidInput.value = nextMinBid.toFixed(2);
        
        var minBidText = document.querySelector('#min-bid-text');
        if (minBidText) {
            minBidText.textContent = 'Minimum bid: ' + formatCurrency(nextMinBid);
        }
    }
    
    function updateBidCount(data) {
        var bidCount = document.querySelector('.bid-count');
        if (!bidCount) { return; }
        
        var count = parseInt(data.bid_count, 10);
        bidCount.textContent = count + ' bid' + (count !== 1 ? 's' : '');
    }
    
    function updateBidDisplay(data) {
        if (!data) { return; }
        
        var currentBidDisplay = document.querySelector('.display-4.fw-bold');
        if (currentBidDisplay) {
            currentBidDisplay.textContent = formatCurrency(data.current_bid);
        }
        
        updateBidHistory(data);
        updateBidForm(data);
        updateBidCount(data);
    }
    
    function formatTimeDisplay(days, hours, minutes) {
        if (days > 0) {
            return days + ' day' + (days !== 1 ? 's' : '') + ' ' + 
                hours + ' hour' + (hours !== 1 ? 's' : '');
        } 
        if (hours > 0) {
            return hours + ' hour' + (hours !== 1 ? 's' : '') + ' ' + 
                minutes + ' minute' + (minutes !== 1 ? 's' : '');
        }
        return minutes + ' minute' + (minutes !== 1 ? 's' : '');
    }
    
    function updateTimerDisplay(days, hours, minutes) {
        var timeDisplay = document.querySelector('.time-remaining');
        if (!timeDisplay) { return; }
        
        timeDisplay.textContent = formatTimeDisplay(days, hours, minutes);
        
        var alertDiv = timeDisplay.closest('.alert');
        if (alertDiv) {
            alertDiv.className = 'alert ' + (days < 1 ? 'alert-warning' : 'alert-info') + ' py-2 mb-3';
        }
    }
    
    function handleAuctionEnd() {
        var auctionStatus = document.querySelector('.auction-status');
        if (auctionStatus) {
            auctionStatus.innerHTML = '<h4 class="mb-0 text-danger">Auction Ended</h4>';
        }
        
        var bidForm = document.querySelector('#bid-form');
        if (bidForm) {
            bidForm.innerHTML = '<div class="alert alert-warning">This auction has ended</div>';
        }
    }
    
    function updateCountdown() {
        fetch('/api/auction/' + productId + '/time')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.time_left !== null) {
                    var days = Math.floor(data.time_left / 86400);
                    var hours = Math.floor((data.time_left % 86400) / 3600);
                    var minutes = Math.floor((data.time_left % 3600) / 60);
                    
                    updateTimerDisplay(days, hours, minutes);
                    
                    if (data.time_left <= 0) {
                        handleAuctionEnd();
                    }
                }
            })
            .catch(function(error) { 
                console.error('Error updating countdown:', error); 
            });
    }
    
    function toggleWatchlist() {
        var watchlistBtn = document.querySelector('.watchlist-btn');
        if (!watchlistBtn) { return; }
        
        watchlistBtn.disabled = true;
        
        fetch('/api/watchlist/toggle/' + productId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(function(response) { 
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); 
        })
        .then(function(data) {
            if (!data.success) {
                throw new Error('Operation failed');
            }
            
            var icon = data.in_watchlist ? 'heart-fill' : 'heart';
            var text = data.in_watchlist ? 'Remove from Watchlist' : 'Add to Watchlist';
            watchlistBtn.innerHTML = '<i class="bi bi-' + icon + '"></i> ' + text;
            
            watchlistBtn.classList.toggle('btn-danger');
            watchlistBtn.classList.toggle('btn-outline-danger');
        })
        .catch(function(error) { 
            console.error('Error toggling watchlist:', error);
            alert('Failed to update watchlist. Please try again.');
        })
        .finally(function() {
            watchlistBtn.disabled = false;
        });
    }
})();
</script>
{% endblock %}
